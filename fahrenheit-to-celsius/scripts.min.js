document.addEventListener("DOMContentLoaded", function() {
    // DOM Elements
    const fahrenheitInput = document.getElementById("fahrenheit");
    const celsiusResult = document.getElementById("celsius-result");
    const copyBtn = document.getElementById("copy-btn");
    const validationMessage = document.getElementById("validation-message");
    const historyList = document.getElementById("history-list");
    const clearHistoryBtn = document.getElementById("clear-history");
    const historyContainer = document.querySelector(".history-container");
    const exampleCards = document.querySelectorAll(".example-card");
    const steps = document.querySelectorAll(".step");

    // Conversion history from localStorage or empty array
    let conversionHistory = JSON.parse(localStorage.getItem("conversionHistory")) || [];

    // Temperature conversion function
    function convertTemperature(fahrenheit) {
        // Clear previous error messages
        validationMessage.textContent = "";
        
        // Handle empty input
        if (fahrenheit === "" || fahrenheit === null || fahrenheit === undefined) {
            celsiusResult.textContent = "--";
            copyBtn.style.display = "none";
            return false;
        }

        const fahrenheitValue = parseFloat(fahrenheit);
        
        // Validate input is a number
        if (isNaN(fahrenheitValue)) {
            celsiusResult.textContent = "--";
            copyBtn.style.display = "none";
            validationMessage.textContent = "Please enter a valid number";
            return false;
        }
        
        // Validate absolute zero (-459.67°F)
        if (fahrenheitValue < -459.67) {
            celsiusResult.textContent = "--";
            copyBtn.style.display = "none";
            validationMessage.textContent = "Temperature cannot be below absolute zero (-459.67°F)";
            return false;
        }
        
        // Perform conversion
        const celsius = (fahrenheitValue - 32) * 5/9;
        const roundedCelsius = Math.round(celsius * 100) / 100; // Keep 2 decimal places
        
        // Update result display
        celsiusResult.textContent = `${roundedCelsius}°C`;
        copyBtn.style.display = "inline-flex";
        
        // Add to history
        addToHistory(fahrenheitValue, roundedCelsius);
        
        // Update step visualizations
        updateStepVisualizations(fahrenheitValue, roundedCelsius);
        
        return true;
    }

    // Add conversion to history
    function addToHistory(fahrenheit, celsius) {
        // Avoid adding duplicate conversions
        if (conversionHistory.length > 0 && 
            conversionHistory[0].fahrenheit === fahrenheit && 
            conversionHistory[0].celsius === celsius) {
            return;
        }

        conversionHistory.unshift({
            fahrenheit: fahrenheit,
            celsius: celsius
        });
        
        // Limit history size
        if (conversionHistory.length > 10) {
            conversionHistory = conversionHistory.slice(0, 10);
        }
        
        // Save and render history
        saveHistory();
        renderHistory();
    }

    // Save history to localStorage
    function saveHistory() {
        try {
            localStorage.setItem("conversionHistory", JSON.stringify(conversionHistory));
        } catch (e) {
            console.error("Error saving to localStorage:", e);
            // Fallback: try saving only last 5 entries
            try {
                localStorage.setItem("conversionHistory", JSON.stringify(conversionHistory.slice(-5)));
            } catch (e) {
                console.error("Failed to save reduced history:", e);
            }
        }
    }

    // Render history list
    function renderHistory() {
        historyList.innerHTML = "";
        
        // Hide history container if no conversions exist
        if (conversionHistory.length === 0) {
            historyContainer.style.display = "none";
            return;
        }
        
        // Show history container when we have conversions
        historyContainer.style.display = "block";
        
        conversionHistory.forEach(item => {
            const li = document.createElement("li");
            li.className = "history-item";
            li.textContent = `${item.fahrenheit}°F = ${item.celsius}°C`;
            li.setAttribute("role", "button");
            li.setAttribute("tabindex", "0");
            li.setAttribute("aria-label", `Apply ${item.fahrenheit}°F to ${item.celsius}°C conversion`);
            
            li.addEventListener("click", () => {
                fahrenheitInput.value = item.fahrenheit;
                convertTemperature(item.fahrenheit);
                fahrenheitInput.focus();
            });
            
            li.addEventListener("keydown", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    fahrenheitInput.value = item.fahrenheit;
                    convertTemperature(item.fahrenheit);
                    fahrenheitInput.focus();
                }
            });
            
            historyList.appendChild(li);
        });
    }

    // Update step-by-step visualization
    function updateStepVisualizations(fahrenheit, celsius) {
        const step1Viz = document.getElementById("step1-viz");
        const step2Viz = document.getElementById("step2-viz");
        const step3Viz = document.getElementById("step3-viz");
        
        if (step1Viz) {
            step1Viz.textContent = `${fahrenheit} - 32 = ${(fahrenheit - 32).toFixed(2)}`;
        }
        
        if (step2Viz) {
            step2Viz.textContent = `${(fahrenheit - 32).toFixed(2)} × 5/9 = ${celsius.toFixed(2)}`;
        }
        
        if (step3Viz) {
            step3Viz.textContent = `Final result: ${celsius.toFixed(2)}°C`;
        }
    }

    // Initialize event listeners
    function initEventListeners() {
        // Input handling with debounce
        const debouncedConvert = debounce(() => {
            convertTemperature(fahrenheitInput.value);
        }, 300);
        
        fahrenheitInput.addEventListener("input", debouncedConvert);
        fahrenheitInput.addEventListener("change", () => convertTemperature(fahrenheitInput.value));
        
        // Copy button functionality
        copyBtn.addEventListener("click", () => {
            if (celsiusResult.textContent === "--") return;
            
            const textToCopy = celsiusResult.textContent;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Show success feedback
                const originalText = copyBtn.querySelector(".btn-text").textContent;
                copyBtn.querySelector(".btn-text").textContent = "Copied!";
                
                setTimeout(() => {
                    copyBtn.querySelector(".btn-text").textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error("Failed to copy:", err);
                // Fallback method
                const textarea = document.createElement("textarea");
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand("copy");
                document.body.removeChild(textarea);
                
                // Still show success feedback
                const originalText = copyBtn.querySelector(".btn-text").textContent;
                copyBtn.querySelector(".btn-text").textContent = "Copied!";
                
                setTimeout(() => {
                    copyBtn.querySelector(".btn-text").textContent = originalText;
                }, 2000);
            });
        });
        
        // Clear history button
        clearHistoryBtn.addEventListener("click", () => {
            conversionHistory = [];
            saveHistory();
            renderHistory();
        });
        
        // Example card clicks
        exampleCards.forEach(card => {
            card.addEventListener("click", () => {
                const value = card.getAttribute("data-value");
                if (value) {
                    fahrenheitInput.value = value;
                    convertTemperature(value);
                }
            });
        });
        
        // Step visualization clicks
        steps.forEach(step => {
            step.addEventListener("click", () => {
                // Toggle active step
                steps.forEach(s => s.classList.remove("active"));
                step.classList.add("active");
                
                // Update visualization if we have input
                if (fahrenheitInput.value) {
                    convertTemperature(fahrenheitInput.value);
                }
            });
        });
    }

    // Debounce function for input events
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this, args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                func.apply(context, args);
            }, wait);
        };
    }

    // Main initialization
    function init() {
        // Set up event listeners
        initEventListeners();
        
        // Render existing history
        renderHistory();
        
        // Check for URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const fahrenheitParam = urlParams.get('fahrenheit');
        
        if (fahrenheitParam) {
            fahrenheitInput.value = fahrenheitParam;
            convertTemperature(fahrenheitParam);
        } else if (fahrenheitInput.value) {
            // Handle browser autofill values
            convertTemperature(fahrenheitInput.value);
        }
        
        // Focus the input field
        fahrenheitInput.focus();
    }

    // Start the application
    init();
});