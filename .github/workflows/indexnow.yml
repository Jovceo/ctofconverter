name: IndexNow Submit

on:
  push:
    branches: [main]

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      # 等待 Vercel 部署完成（通常 1-2 分钟）
      - name: Wait for Vercel deployment
        run: sleep 120

      - name: Submit URLs to IndexNow
        env:
          INDEXNOW_SECRET: ${{ secrets.INDEXNOW_SECRET }}
        run: |
          # 使用默认 secret 如果 GitHub Secrets 未设置
          SECRET="${INDEXNOW_SECRET:-ctof-indexnow-2026}"
          
          echo "Submitting URLs to IndexNow via API route..."
          RESPONSE=$(curl -s -X POST "https://ctofconverter.com/api/indexnow?secret=${SECRET}")
          echo "$RESPONSE"
          
          # 检查是否成功
          SUCCESS=$(echo "$RESPONSE" | grep -o '"success":true')
          if [ -z "$SUCCESS" ]; then
            echo "⚠️ IndexNow submission may have failed, but this is non-blocking"
          else
            echo "✅ IndexNow submission successful!"
          fi