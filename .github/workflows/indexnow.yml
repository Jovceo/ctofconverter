name: IndexNow Submit

on:
  push:
    branches: [main]

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ÈúÄË¶ÅÂâç‰∏Ä‰∏™ commit Êù•ÂÅö diff

      # Á≠âÂæÖ Vercel ÈÉ®ÁΩ≤ÂÆåÊàêÔºàÈÄöÂ∏∏ 1-2 ÂàÜÈíüÔºâ
      - name: Wait for Vercel deployment
        run: sleep 120

      - name: Detecting changed URLs and submit to IndexNow
        env:
          INDEXNOW_SECRET: ${{ secrets.INDEXNOW_SECRET }}
        run: |
          # 1. Install dependencies
          npm install

          # 2. Generate fresh sitemap.xml
          node scripts/generate-sitemap.js
          
          # 3. Detect Added .tsx files (New Pages)
          # --diff-filter=A ensures we only care about NEW files, not modified ones.
          ADDED_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep "^pages/.*\.tsx$" || true)
          
          if [ -z "$ADDED_FILES" ]; then
            echo "‚ÑπÔ∏è No new pages added. Skipping IndexNow submission."
            exit 0
          fi
          
          echo "üìù Newly added pages:"
          echo "$ADDED_FILES"
          
          # 4. Extract corresponding URLs from sitemap.xml
          # We search sitemap.xml for URLs matching the filenames
          URLS=""
          
          for FILE in $ADDED_FILES; do
             # Convert "pages/foo.tsx" -> "foo"
             SLUG=$(echo "$FILE" | sed 's/^pages\///' | sed 's/\.tsx$//')
             
             if [ "$SLUG" == "index" ]; then
                SLUG=""
             fi
             
             # Grep for <loc> entries containing the slug
             # Note: This finds all locales for that page (e.g. /foo, /zh/foo, /fr/foo...)
             # which is exactly what we want when a new page is created.
             if [ -z "$SLUG" ]; then
                # Special case for exact index match to avoid matching everything
                 MATCHED_URLS=$(grep -oP '(?<=<loc>).*?(?=</loc>)' public/sitemap.xml | grep -E "https://ctofconverter.com/$" || true)
             else
                 MATCHED_URLS=$(grep -oP '(?<=<loc>).*?(?=</loc>)' public/sitemap.xml | grep "/$SLUG$" || true)
             fi
             
             if [ ! -z "$MATCHED_URLS" ]; then
               # Replace newlines with commas
               ADDED_URLS=$(echo "$MATCHED_URLS" | tr '\n' ',')
               URLS="${URLS}${ADDED_URLS}"
             fi
          done
          
          # Clean up trailing/leading commas
          URLS=$(echo "$URLS" | sed 's/^,//' | sed 's/,$//' | sed 's/,,/,/g')
          
          if [ -z "$URLS" ]; then
            echo "‚ö†Ô∏è Could not resolve URLs from sitemap for the added files."
            exit 0
          fi
          
          echo "üöÄ Submitting New URLs to IndexNow:"
          echo "$URLS" | tr ',' '\n'
          
          # 5. Submit to IndexNow via API
          RESPONSE=$(curl -s -X POST "https://ctofconverter.com/api/indexnow?secret=${INDEXNOW_SECRET}&urls=${URLS}")
          echo "Server Response: $RESPONSE"