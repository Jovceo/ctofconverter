name: IndexNow Submit

on:
  push:
    branches: [main]

jobs:
  indexnow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦å‰ä¸€ä¸ª commit æ¥åš diff

      # ç­‰å¾… Vercel éƒ¨ç½²å®Œæˆï¼ˆé€šå¸¸ 1-2 åˆ†é’Ÿï¼‰
      - name: Wait for Vercel deployment
        run: sleep 120

      - name: Detecting changed URLs and submit to IndexNow
        env:
          INDEXNOW_SECRET: ${{ secrets.INDEXNOW_SECRET }}
        run: |
          # 1. Install dependencies to run generation script
          npm install

          # 2. Generate fresh sitemap.xml
          node scripts/generate-sitemap.js
          
          SECRET="${INDEXNOW_SECRET:-ctof-indexnow-2026}"
          SITE="https://ctofconverter.com"
          LOCALES="en zh es hi ar ja fr de id pt-br"
          URLS=""

          # è·å–æœ¬æ¬¡ push å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "âš ï¸ No changed files detected, skipping IndexNow submission"
            exit 0
          fi

          echo "ğŸ“ Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # æ ‡è®°ï¼šæ˜¯å¦éœ€è¦æäº¤å…¨ç«™
          SUBMIT_ALL=false

          # æ£€æµ‹æ˜¯å¦æœ‰å…¨å±€æ€§å˜æ›´ï¼ˆç»„ä»¶ã€å¸ƒå±€ã€æ ·å¼ã€é…ç½®ç­‰å½±å“æ‰€æœ‰é¡µé¢çš„æ–‡ä»¶ï¼‰
          if echo "$CHANGED_FILES" | grep -qE '^(components/|styles/|pages/_app|pages/_document|next\.config|public/sitemap)'; then
            echo "ğŸŒ Global change detected, submitting all URLs from sitemap"
            SUBMIT_ALL=true
          fi

          if [ "$SUBMIT_ALL" = true ]; then
            # å…¨å±€å˜æ›´ï¼šä» sitemap æå–å…¨éƒ¨ URL
            URLS=$(grep -oP '(?<=<loc>).*?(?=</loc>)' public/sitemap.xml | tr '\n' ',')
          else
            # ç²¾å‡†æäº¤ï¼šåªæäº¤å˜æ›´æ–‡ä»¶å¯¹åº”çš„ URL
            
            # 1) locale JSON å˜æ›´ â†’ å¯¹åº”è¯­è¨€ + é¡µé¢çš„ URL
            for FILE in $CHANGED_FILES; do
              # åŒ¹é… locales/{locale}/home.json â†’ /{locale}/ (é¦–é¡µ)
              if echo "$FILE" | grep -qP '^locales/([^/]+)/home\.json$'; then
                LOCALE=$(echo "$FILE" | sed -n 's|^locales/\([^/]*\)/home\.json$|\1|p')
                if [ "$LOCALE" = "en" ]; then
                  URLS="${URLS}${SITE}/,"
                else
                  URLS="${URLS}${SITE}/${LOCALE},"
                fi
              fi

              # åŒ¹é… locales/{locale}/{page}.json â†’ /{locale}/{page}
              if echo "$FILE" | grep -qP '^locales/([^/]+)/(?!home\.json)([^/]+)\.json$'; then
                LOCALE=$(echo "$FILE" | sed -n 's|^locales/\([^/]*\)/\([^/]*\)\.json$|\1|p')
                PAGE=$(echo "$FILE" | sed -n 's|^locales/\([^/]*\)/\([^/]*\)\.json$|\2|p')
                if [ "$LOCALE" = "en" ]; then
                  URLS="${URLS}${SITE}/${PAGE},"
                else
                  URLS="${URLS}${SITE}/${LOCALE}/${PAGE},"
                fi
              fi

              # åŒ¹é… public/locales/{locale}/{page}.json â†’ /{locale}/{page}
              if echo "$FILE" | grep -qP '^public/locales/([^/]+)/([^/]+)\.json$'; then
                LOCALE=$(echo "$FILE" | sed -n 's|^public/locales/\([^/]*\)/\([^/]*\)\.json$|\1|p')
                PAGE=$(echo "$FILE" | sed -n 's|^public/locales/\([^/]*\)/\([^/]*\)\.json$|\2|p')
                if [ "$LOCALE" = "en" ]; then
                  URLS="${URLS}${SITE}/${PAGE},"
                else
                  URLS="${URLS}${SITE}/${LOCALE}/${PAGE},"
                fi
              fi
            done

            # 2) é¡µé¢ TSX å˜æ›´ â†’ æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬çš„è¯¥é¡µé¢ URL
            for FILE in $CHANGED_FILES; do
              if echo "$FILE" | grep -qP '^pages/(?!_|api/)([^/]+)\.tsx$'; then
                PAGE=$(echo "$FILE" | sed -n 's|^pages/\([^/]*\)\.tsx$|\1|p')
                if [ "$PAGE" = "index" ]; then
                  # é¦–é¡µ â†’ æ‰€æœ‰è¯­è¨€é¦–é¡µ
                  for L in $LOCALES; do
                    if [ "$L" = "en" ]; then
                      URLS="${URLS}${SITE}/,"
                    else
                      URLS="${URLS}${SITE}/${L},"
                    fi
                  done
                else
                  # å…¶ä»–é¡µé¢ â†’ æ‰€æœ‰è¯­è¨€ç‰ˆæœ¬
                  for L in $LOCALES; do
                    if [ "$L" = "en" ]; then
                      URLS="${URLS}${SITE}/${PAGE},"
                    else
                      URLS="${URLS}${SITE}/${L}/${PAGE},"
                    fi
                  done
                fi
              fi
            done
          fi

          # å»é‡å¹¶æ¸…ç†
          URLS=$(echo "$URLS" | tr ',' '\n' | sort -u | grep -v '^$' | tr '\n' ',' | sed 's/,$//')

          if [ -z "$URLS" ]; then
            echo "â„¹ï¸ No URL-affecting changes detected (e.g. only README, .github, etc.)"
            echo "Skipping IndexNow submission."
            exit 0
          fi

          URL_COUNT=$(echo "$URLS" | tr ',' '\n' | wc -l)
          echo ""
          echo "ğŸš€ Submitting ${URL_COUNT} changed URLs to IndexNow:"
          echo "$URLS" | tr ',' '\n'
          echo ""

          # é€šè¿‡ API è·¯ç”±æäº¤ï¼ˆæ”¯æŒ urls å‚æ•°ç²¾å‡†æäº¤ï¼‰
          RESPONSE=$(curl -s -X POST "${SITE}/api/indexnow?secret=${SECRET}&urls=${URLS}")
          echo "$RESPONSE"

          # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
          SUCCESS=$(echo "$RESPONSE" | grep -o '"success":true')
          if [ -z "$SUCCESS" ]; then
            echo "âš ï¸ IndexNow submission may have failed, but this is non-blocking"
          else
            echo "âœ… IndexNow submission successful!"
          fi